## 主动信息收集-DDOS 攻击防御-SYN 洪水攻击

### 基于 ping 命令的探测
- PING 命令是我们常用的判断主机之间网络是否畅通，同样也是能判断我们的目标主机是否存活
- Traceroute 命令也可以对路由进行跟踪
- ARPING
  >1，ARP 协议概述：ARP 协议是“Address Resolution Protocol”（地址解析协议）的缩写。计算
  机通过 ARP 协议将 IP 地址转换成 MAC 地址。
  >2，使用 netdiscover 进行被动方式探测局域网中存活的机器
  netdiscover 是一个主动/被动的 ARP 侦查工具。使用 netdiscover 工具可以在网络上扫描 IP 地址，检查在线主机或搜索为它们发送的 ARP 请求
- 用 FPING 查看局域网中运行了哪些机器

### TCP 三次握手和四次挥手原理及抓包过程
> ACK ： TCP 协议规定，只有 ACK=1 时有效，也规定连接建立后所有发送的报文的 ACK 必须为 1

> SYN(SYNchronization) ： 在连接建立时用来同步序号。当 SYN=1 而 ACK=0 时，表明这是一 个连接请求报文。
> 对方若同意建立连接，则应在响应报文中使 SYN=1 和 ACK=1. 因此, SYN 置 1 就表 示这是一个连接请求或连接接受报文

> FIN （finis）即完，终结的意思， 用来释放一个连接。当 FIN = 1 时，表明此报文段的发送方的 数据已经发送完毕，并要求释放连接

- tcpdump 抓包查看三次握手过程
> 三次握手的核心是： 确认每一次包的序列号。 tcp 三次握手过程：
1.首先由 Client 发出连接请求即 SYN=1，声明自己的序号是 seq=x
2.然后 Server 进行回复确认，即 SYN=1 ，声明自己的序号是 seq=y, 并设置为 ack=x+1,
3.最后 Client 再进行一次确认，设置 ack=y+1.
- tcp 四次挥手
> 1.第一次挥手：服务端发送一个[FIN+ACK]，表示自己没有数据要发送了，想断开连接，并进入FIN_WAIT_1 状态
2.第二次挥手：客户端收到 FIN 后，知道不会再有数据从服务端传来，发送 ACK 进行确认，确认序号为收到序号+1（与 SYN 相同，一个 FIN 占用一个序号），客户端进入 CLOSE_WAIT 状态。
3.第三次挥手：客户端发送 [FIN+ACK] 给对方，表示自己没有数据要发送了，客户端进入LAST_ACK 状态，然后直接断开 TCP 会话的连接，释放相应的资源
4.第四次挥手：服务户端收到了客户端的 FIN 信令后，进入 TIMED_WAIT 状态，并发送 ACK 确认消息。服务端在 TIMED_WAIT 状态下，等待一段时间，没有数据到来，
就认为对面已经收到了自己发送的ACK 并正确关闭了进入 CLOSE 状态，自己也断开了 TCP 连接，释放所有资源。当客户端收到服务端的ACK 回应后，会进入 CLOSE 状态并关闭本端的会话接口，释放相应资源。


### 基于 Nmap 的扫描方式
- Nmap 的基本扫描方式 (nmap -sn 192.168.1.0/24),nmap 扫描类型主要有 TCP 的全连接扫描（会在被扫描机器留下记录），半连接扫描（不会留下记 录）
- 用 nc 扫描端口 (nc -nv -w 1 -z 192.168.1.1 1-100)

### SYN 洪水攻击和 DDOS 攻击防御手段
- 使用 hping3 进行 SYN Flood 洪水攻击
> SYN 洪水攻击概述：SYN 洪水攻击主要源于：tcp 协议的三次握手机制

> SYN 洪水攻击的过程：
  在服务端返回一个确认的 SYN-ACK 包的时候有个潜在的弊端，如果发起的客户是一个不存在的客户 端，那么服务端就不会接到客户端回应的 ACK 包。
  这时服务端需要耗费一定的数量的系统内存来等待这个未决的连接，直到等待超时关闭，才能释放内 存。
  如果恶意者通过通过 ip 欺骗，发送大量 SYN 包给受害者系统，导致服务端存在大量未决的连接并占 用大量内存和 tcp 连接，
> 从而导致正常客户端无法访问服务端，这就是 SYN 洪水攻击的过程。
  
> hping3 是一个命令行下使用的 TCP/IP 数据包组装/分析工具，通常 web 服务会用来做压力测试使 用，
> 也可以进行 DOS 攻击的实验。同样 hping3 每次只能扫描一个目标。 例：使用 hping3 进行压力测试

>  eg: hping3 -c 100000 -d 120 -S -p 80 --flood --rand-source 192.168.1.63
- 通过优化系统参数缓解 DDOS 攻击
> 优化 Linux 内核参数提升 SYN
```shell
net.ipv4.tcp_syncookies = 1
#打开 SYN cookies 功能，该功能可以尽量把过多的 SYN 请求缓存起来
net.ipv4.tcp_max_syn_backlog = 262144
#定义 backlog 队列能容纳的最大半连接数，Centos 系统中该值默认为 256，是远远不够的。
net.ipv4.tcp_synack_retries = 1
#表示收到 SYN 后发送 SYN+ACK 的重传次数，默认为 5 表示重试 5 次，而且 每次重试的间隔会
#翻倍。1、2、4、8、16 秒，最后一次重试后等待 32 秒，若仍然没有收到 ACK，才会关闭连接，故共
#需要等待 63 秒。日常中这个值推荐设置为 2 秒，目前网络环境延迟没有以前那么高所以 2 秒可以满足
#日常使用，攻击比较多的时候可适当为 1 秒。
net.core.somaxconn = 65535
#上面所提到的 backlog 队列实际上受限于系统级的队列上限，通过修改 net.core.somaxconn 来提高系统队列上限。
```
- ss 命令概述： ss 是 Socket Statistics 的缩写。用来获取 socket 统计信息。它可以显示和 netstat 类似的内容。
ss 的优势在于它能够显示更多更详细的有关 TCP 和连接状态的信息，而且比 netstat 更快速更高效。
> ss -lnt
